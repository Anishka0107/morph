#data-table
  - if scraper.database.valid?
    - active_table = scraper.database.first_table_name

    - if active_table
      %header.data-header
        %h3 Data
        %p.scraper-data-usage
          %strong
            Downloaded
            = scraper.downloads.count
            times
          by
          - # TODO: Replace this hardcoded stuff to show people/orgs who downloaded the scraper
          %a{:href => "/ciudadanointeligente"}
            %img.has-tooltip{:alt => "ciudadanointeligente", "data-container" => "body", "data-original-title" => "", "data-placement" => "bottom", "data-title" => "Downloaded 5782 times by ciudadanointeligente", :height => "30", :src => "https://gravatar.com/avatar/15c938035f91373cb36062d6ad4ef2e5?d=https%3A%2F%2Fidenticons.github.com%2F6738e91db5a8843ba60d9147dd297d5a.png&r=x&s=30", :title => "", :width => "30"}/
          %a{:href => "/jacksongs"}
            %img.img-circle.has-tooltip{:alt => "jacksongs", "data-container" => "body", "data-original-title" => "", "data-placement" => "bottom", "data-title" => "jacksongs", :height => "30", :src => "https://avatars.githubusercontent.com/u/1189369?v=3&s=30", :title => "", :width => "30"}/
          %a{:href => "/rezzo"}
            %img.img-circle.has-tooltip{:alt => "rezzo", "data-container" => "body", "data-placement" => "bottom", "data-title" => "rezzo", :height => "30", :src => "https://avatars.githubusercontent.com/u/153339?v=3&s=30", :width => "30"}/
          %a{:href => "/martinszy"}
            %img.img-circle.has-tooltip{:alt => "martinszy", "data-container" => "body", "data-placement" => "bottom", "data-title" => "martinszy", :height => "30", :src => "https://avatars.githubusercontent.com/u/997732?v=3&s=30", :width => "30"}/

      %ul.nav.nav-tabs
        - scraper.database.table_names.each do |table|
          %li{class: ("active" if table == active_table)}
            = link_to table, "#table_#{table}", data: {toggle: "tab"}

      .tab-content
        - scraper.database.table_names.each do |table|
          .tab-pane{class: ("active" if table == active_table), id: "table_#{table}"}
            - rows = scraper.database.first_ten_rows(table)
            %p
              - unless signed_in?
                To download data
                = button_link_to "sign in with GitHub", user_omniauth_authorize_path(:github)
              .btn-group
                = button_link_to "Download table (as CSV)", data_scraper_path(scraper, format: :csv, query: scraper.database.select_all(table), key: (current_user.api_key if current_user)), disabled: !signed_in?
                = button_link_to "Download SQLite database (#{number_to_human_size scraper.database.sqlite_db_size})", data_scraper_path(scraper, :format => :sqlite, key: (current_user.api_key if current_user)), disabled: !signed_in?
                = button_link_to "Use the API", api_documentation_index_path(scraper: scraper.full_name)
            %p rows #{[10, scraper.database.no_rows(table)].min} / #{scraper.database.no_rows(table)}
            .table-responsive.scraper-data.scroller-frame
              %table.table.table-striped.table-bordered.table-condensed.tablesaw.tablesaw-stack.scroller-panel{data: {tablesaw: {mode: "stack" }}}
                - unless rows.empty?
                  %thead
                    %tr
                      - rows.first.each_key do |field|
                        %th= field
                  %tbody
                    - rows.each do |row|
                      %tr
                        - row.each_value do |v|
                          %td
                            %div.has-popover{data: {toggle: "popover", placement: "bottom", trigger: "hover", content: v, container: "body"}}
                              = link_url_or_escape(v.to_s)
  - else
    %h3 Data
    .alert.alert-danger(role="alert")
      The sqlite database is not valid. This is very unusual.
      It may have happened if the scraper died
      unexpectedly in the middle of writing to the database.

      - if can? :destroy, scraper
        To fix this:
        %ol
          %li= button_link_to "Download a copy of the current sqlite database", data_scraper_path(scraper, :format => :sqlite, key: current_user.api_key)
          %li= button_to "Clear the database", clear_scraper_path(scraper), {class: "btn btn-danger"}
          %li Rerun your scraper
      - else
        The owner of this scraper can take some simple steps to fix this.
